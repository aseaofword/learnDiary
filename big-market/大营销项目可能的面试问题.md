# 大营销项目面试问题

## 1.你在项目中用到了DDD架构，你能说一下DDD架构的好处吗？和MVC相比有什么区别和优势？

我先回答一下第一个问题，DDD架构的好处：

DDD架构的核心思想是根据业务领域来划分，更加地贴近业务，把业务逻辑分成了4个层次，领域层只关心业务逻辑实现，是DDD架构的核心，其中主要是由entity，value object，领域服务和领域事件来组成，基础服务层，基础服务层封装了仓储服务，包括对redis，mysql，rabbitmq的使用，领域层来定义接口，基础服务层进行实现，领域层不需要关心仓储服务是如何实现的。然后就是应用层，应用层来组装业务逻辑。接下来就是接口层，主要是暴露api和进行数据的转换，主要的对象包括dto和vo。

我再回答一下第二个问题：

MVC把业务分成视图层，service层还有DAO层，随着业务不断得迭代，service的代码可能会越写越多，Service层逐渐塞满了校验、流程、状态变更、调用其他服务等各种逻辑，变成“万能大杂烩”。结果：代码越来越长，后人维护时不敢动，改动还容易牵一发而动全身。

👉 **比如订单功能**
 最初`OrderService`只负责创建订单，后来加了支付、优惠券、库存扣减、积分奖励、订单状态流转，最终变成了几千行大类，每次改个功能都提心吊胆。

## 2.你的抽奖流程中哪些被定义成值对象，哪些被定义成实体对象？

值对象一般是指没有主键id，用来描述对象属性的对象，像是枚举值之类的，不会影响数据的变化。

实体对象是流程的活动实体，记录流程进行步骤和中间结果，会最终持久化到数据库中的对象，而且一些和实体类相关的功能可以直接聚合到实体类中，通用性会更好。避免调用方各自编写逻辑

## 3. 关于访问数据层的依赖倒置，是怎么使用的，有什么好处，你可以描述下吗？

DDD中的依赖倒置是一个非常好的设计，在MVC架构里面，数据库的持久化对象很容易被当成是业务对象来使用，随着业务不断扩展，会越来越难维护，但是在DDD架构中，由domain层来定义接口，基础设施层来引用domain层实现接口，这样po对象被限制在了基础设施层不会进入业务范围，只跟数据库表相关不会随着业务的扩展越来越臃肿。

## 4.我看你简历有提到，把抽奖划分为抽奖前、中、后，三个动作。请具体结合场景讲解下，为什么这样设计？

为了便于以后的扩展，黑名单抽奖、权重抽奖、默认抽奖、抽奖N次解锁、兜底抽奖等等情况，是可以拆解为抽奖前、中、后，3个行为动作的，基于这样的考虑后，就可以设计出非常容易扩展的松耦合结构。

## 5.是什么场景下使用了责任链模式，什么场景使用了组合模式，为什么？

在拆解完抽奖前、中、后三个抽奖流程后，抽奖前主要是判断进行哪种抽奖模式，比如黑名单、权重、默认等，也就是只有一种情况会成立，比较适合使用责任链来实现。而抽奖中和抽奖后的流程会更为复杂，包括次数锁的判断，未达到指定的抽奖次数就走向兜底奖励，如果满足次数锁则尝试扣减库存，若是库存不足则走向兜底奖励，这样的情况下更加适合使用组合模式来构建一个规则树。也方便后续的扩展。

## 6.抽奖也是一种瞬时峰值很高的业务场景，那么对于抽中奖品后的库存扣减是怎么做的？

库存扣减是抽奖流程中比较核心的流程，请求量很高，如果直接去修改mysql中的数据，会造成用户等待扣减库存的线程释放，一般情况数据库的线程配置是较少的。所以会有一个装配的阶段，把数据库的库存加载到redis中，使用DECR指令对库存进行减一，还有为了一些需要恢复库存的异常情况，每次扣减成功后会对此次扣减的数字setnx加一个锁进行兜底保证不超卖，也就是滑块锁。

## 7. 你讲到库存的扣减是通过 Redis 滑块锁实现的👍🏻，那么最终同步库是怎么做的，怎么降低对数据库的压力的？

关于redis和数据库信息同步的流程，设计了异步更新的流程，当库存扣减完后，会向redis的异步队列中发送一条消息，然后由定时任务进行消费，之后通过定时 Schedule Job 来消费队列。这样就可以控制效率速率，降低对数据库的压力。

## 8.在项目中你提到了可以支持不同场景的抽奖诉求，比如；多少积分后可以抽奖一个固定范围的奖品，或者抽奖n次后，才可以中奖某个奖品。这部分你是怎么做的？库表怎么设计的？

这一块的业务是分成策略表、策略奖励表、规则表、奖励表，还有与规则树相关的树表、树节点表、树分叉表。策略表用来记录策略id还有策略规则。策略奖励用来记录奖励的明细信息，库存还有使用的规则key。规则表就是记录计算规则时所需的字段。

## 9.你的抽奖接口响应时间是多少？

在2g4g的云服务器上大概是50~100ms。

### 10.（开放问题）你在做项目中，什么问题难住你的时间最长，为什么？